<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="http://ajax.cdnjs.com/ajax/libs/json2/20110223/json2.js"></script>
    <script src="http://ajax.cdnjs.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
    <script src="http://ajax.cdnjs.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"></script>
</head>

<div id="ehp"></div>

<script type="text/template" id="simulation-template">
    <label>Mob level</label>
    <input type="text" class="moblevel" value="" /> <br />

    <label>Life</label>
    <input type="text" class="life" value="" /> <br />

    <label>Armor</label>
    <input type="text" class="base_armor" value="" />  <br />

    <label>Tough As Nails</label>
    <input type="checkbox" class="toughasnails" value="1" /> <br />

    <label>Vit To Armor</label>
    <input type="checkbox" class="vittoarmor" value="1" /> <br />

    <label>WarCry normal</label>
    <input type="checkbox" class="warcry" value="1" /> <br />

    <label>WarCry runed +armor</label>
    <input type="checkbox" class="warcry_armor" value="1" /> <br />

    <input type="text" readonly=true class="armor" value="" />
    <span class="armor_reduc"></span> <br />

    <label>Resistance</label>
    <input type="text" class="base_resist" value="" /> <br />

    <label>WarCry runed +resist</label>
    <input type="checkbox" class="warcry_resist" value="1" /> <br />

    <input type="text" readonly=true class="resist" value="" />
    <span class="resist_reduc"></span> <br />

    <label>Threatening Shout (you can't get it on ranged)</label>
    <input type="checkbox" class="threat_shout" value="1" /> <br />

    <label>Superstition (won't work on physical)</label>
    <input type="checkbox" class="superstition" value="1" /> <br />

    <hr />
    <label>EHP</label>
    <input type="text" readonly=true class="ehp" value="" />
    <button class="reset">refresh</button>
</script>

<script>
(function($) {
	var Simulation = Backbone.Model.extend({
	    defaults : {
            life:         30000,
		    base_armor:   4000,
		    base_resist:  400,
		    
		    melee:        true,
	
	        toughasnails: false,
	        vittoarmor:   false,
            warcry:       false,
            warcry_armor: false,
            warcry_resist:false,
            threat_shout: false,
            superstition: false,
		    
		    moblevel:    63,

            armor:        null,
            resist:       null,
            armor_reduc:  null,
            resist_reduc: null,
	    },
	  
	    initialize : function () {
	    	console.log(this);
	    	
	    	this.on('change', this.simulate);
	
	    	this.simulate();
	    },
	  
	    simulate : function () {
            this.set('armor', this.get('base_armor'));
            this.set('resist', this.get('base_resist'));
            
            if (this.get('toughasnails')) {
                this.set('armor', this.get('armor') * 1.25);
            }
            if (this.get('vittoarmor')) {
                this.set('armor', this.get('armor') + 1200);
            }
            if (this.get('warcry_armor')) {
                this.set('armor', this.get('armor') * 1.4);
            } else if (this.get('warcry')) {
                this.set('armor', this.get('armor') * 1.2);
            }
            
            if (this.get('warcry_resist')) {
                this.set('resist', this.get('resist') * 1.50);
            }
            
            this.set('armor_reduc', this.get('armor') / (50 * this.get('moblevel') + this.get('armor')));
            this.set('resist_reduc', this.get('resist') / (5 * this.get('moblevel') + this.get('resist')));
            
            var modifier = 1;
            modifier *= (1 - this.get('armor_reduc'));
            modifier *= (1 - this.get('resist_reduc'));

            if (this.get('threat_shout')) {
                modifier *= (1 - 0.25);
            }
            
            if (this.get('superstition')) {
                modifier *= (1 - 0.20);
            }
            
            if (this.get('melee')) {
                modifier *= (1 - 0.30);
            }
            
            var ehp = this.get('life') / modifier;
	    	
		    this.set('ehp', ehp);
	    }
	});

	var SimulationView = Backbone.View.extend({
		el: $('body'),
		
		events: {
            'change input':       'viewToModel',
            'click button.reset': 'viewToModel'
		},
		
		fieldMap: {
            '.life':            'life',
            '.base_armor':      'base_armor',
            '.base_resist':     'base_resist',
            '.toughasnails':    'toughasnails',
            '.vittoarmor':      'vittoarmor',
            '.warcry':          'warcry',
            '.warcry_armor':    'warcry_armor',
            '.warcry_resist':   'warcry_resist',
            '.threat_shout':    'threat_shout',
            '.superstition':    'superstition',
            
            '.moblevel':        'moblevel',

            '.armor':           'armor',
            '.resist':          'resist',
            '.armor_reduc':     'armor_reduc',
            '.resist_reduc':    'resist_reduc',  
            
            '.ehp':             'ehp'
		},
		
		initialize: function() {
			_.bindAll(this, 'render', 'modelToView', 'viewToModel');

			this.model    = new Simulation;
			this.template = _.template($('#simulation-template').html());
			
			this.model.on('change', this.modelToView, this);
			
			this.render();
            this.modelToView();
		},
		
		viewToModel: function() {
			console.log('viewToModel');

            _.each(this.fieldMap, function(field, selector) {            	
                var $fieldObj = $(selector,  this.el);

                if ($fieldObj.is('span')) {
                    // -- 
                } else if ($fieldObj.is('input') && $fieldObj.prop('type') == 'checkbox') {
                    this.model.set(field, !!$fieldObj.prop('checked'), {silent: true});
                } else if ($fieldObj.is('input') && $fieldObj.prop('type') == 'text' && !$fieldObj.prop('readonly')) {
                    this.model.set(field, parseInt($fieldObj.val()), {silent: true});
                }
            }, this);
            
            _.each(this.fieldMap, function(field, selector) {
                this.model.change(field);
            }, this);
		},
		
		modelToView: function() {
            console.log('modelToView');
            
            _.each(this.fieldMap, function(field, selector) {
            	var $fieldObj = $(selector,  this.el);
            	
            	if ($fieldObj.is('span')) {
                    $fieldObj.html(this.model.get(field));
                } else if ($fieldObj.is('input') && $fieldObj.prop('type') == 'checkbox') {
                    $fieldObj.prop('checked', !!this.model.get(field));
                } else if ($fieldObj.is('input') && $fieldObj.prop('type') == 'text') {
                    $fieldObj.val(this.model.get(field));
            	}
            }, this);
		},
		
		render: function() {			
	        $(this.template()).appendTo($(this.el));
		},
	});
	
	var simView = new SimulationView();
})(jQuery);
</script>
</html>